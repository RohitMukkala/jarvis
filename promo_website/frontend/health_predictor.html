<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Health Predictor - Jarvis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <link rel="icon" type="image/x-icon" href="logo.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .tab-button.active {
        background-color: #0891b2;
        color: white;
      }
      .tab-button {
        background-color: #374151;
        color: #d1d5db;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .gauge-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 1rem auto;
      }
      .gauge-circle {
        fill: none;
        stroke-width: 15;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }
      .gauge-meter {
        transition: stroke-dashoffset 1s ease-in-out;
      }
      .gauge-text {
        font-size: 1.5rem;
        font-weight: bold;
        fill: white;
      }
      .metric-highlight {
        border: 2px solid #f87171;
        border-radius: 0.5rem;
        padding: 0.5rem;
        margin: -0.5rem;
        background-color: rgba(248, 113, 113, 0.1);
      }
      .loader {
        border: 4px solid #374151;
        border-top: 4px solid #0891b2;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-cyan-400">AI Health Predictor</h1>
        <p class="text-gray-400 mt-2">
          Enter your health metrics manually or upload a file to get a
          prediction.
        </p>
      </div>

      <div class="space-y-8">
        <!-- Predictor Tool -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <!-- Tab Buttons -->
          <div class="flex border-b border-gray-700 mb-6">
            <button
              class="tab-button flex-1 py-3 px-4 rounded-t-lg transition-colors duration-300 active"
              data-tab="manual"
            >
              Manual Entry
            </button>
            <button
              class="tab-button flex-1 py-3 px-4 rounded-t-lg transition-colors duration-300"
              data-tab="pdf"
            >
              Upload PDF
            </button>
          </div>

          <!-- Manual Entry Form -->
          <div id="manual" class="tab-content active">
            <form id="healthForm">
              <p class="text-xs text-gray-500 mb-4">
                Enter the 13 required health features below.
              </p>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
              <button
                type="submit"
                class="w-full mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded transition-colors duration-300"
              >
                Get Prediction
              </button>
            </form>
          </div>

          <!-- PDF Upload -->
          <div id="pdf" class="tab-content">
            <p class="text-gray-400 mb-4">
              Upload a medical report PDF. The system will attempt to find and
              parse the 13 required values.
            </p>
            <input
              type="file"
              id="pdfFile"
              accept=".pdf"
              class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-cyan-700 file:text-white hover:file:bg-cyan-800"
            />
            <button
              id="pdfSubmit"
              class="w-full mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded transition-colors duration-300"
            >
              Predict from PDF
            </button>
          </div>

          <!-- Prediction Result -->
          <div id="result" class="mt-6 text-center text-lg"></div>
        </div>
      </div>
      <!-- Understanding the Health Metrics -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg mt-10">
        <h2 class="text-2xl font-bold text-cyan-400 mb-4 text-center">
          Understanding the Health Metrics
        </h2>
        <div class="space-y-4 text-gray-300 text-sm leading-relaxed">
          <p>
            <span class="font-semibold text-white">Age:</span> Age in years.
            Risk factors can increase with age.
          </p>
          <p>
            <span class="font-semibold text-white">Sex:</span> Biological sex (1
            = male; 0 = female).
          </p>
          <p>
            <span class="font-semibold text-white">CP:</span> Chest Pain Type
            (0‚Äì3). Any chest pain should be evaluated by a doctor.
          </p>
          <p>
            <span class="font-semibold text-white">Trestbps:</span> Resting
            Blood Pressure in mm Hg. A healthy range is typically below 120.
          </p>
          <p>
            <span class="font-semibold text-white">Chol:</span> Serum
            Cholesterol in mg/dL. A healthy level is below 200.
          </p>
          <p>
            <span class="font-semibold text-white">FBS:</span> Fasting Blood
            Sugar &gt; 120 mg/dL (1 = true; 0 = false). Indicates potential
            diabetes risk.
          </p>
          <p>
            <span class="font-semibold text-white">RestECG:</span> Resting ECG
            Results (0‚Äì2). '0' is normal.
          </p>
          <p>
            <span class="font-semibold text-white">Thalach:</span> Max Heart
            Rate Achieved. Varies with age (approx. 220 ‚àí age).
          </p>
          <p>
            <span class="font-semibold text-white">Exang:</span> Exercise
            Induced Angina (1 = yes; 0 = no). A significant symptom.
          </p>
          <p>
            <span class="font-semibold text-white">Oldpeak:</span> ST
            Depression. A measure from an ECG during exercise. Lower is better.
          </p>
          <p>
            <span class="font-semibold text-white">Slope:</span> Slope of ST
            Segment (0‚Äì2).
          </p>
          <p>
            <span class="font-semibold text-white">CA:</span> Major Vessels
            Colored (0‚Äì3). '0' is best.
          </p>
          <p>
            <span class="font-semibold text-white">Thal:</span> Thalassemia
            Defect (1‚Äì3). '1' (normal) is ideal.
          </p>
        </div>
        <p class="mt-6 text-xs text-gray-400 italic text-center">
          ‚ö†Ô∏è Disclaimer: This AI prediction is for informational purposes only
          and is not a substitute for professional medical consultation. Always
          consult with a qualified healthcare provider.
        </p>
      </div>

      <div class="text-center mt-8">
        <a href="./dashboard.html" class="text-cyan-500 hover:underline"
          >&larr; Back to Dashboard</a
        >
      </div>
    </div>

    <script>
      const metrics = [
        { label: "Age", placeholder: "e.g., 52" },
        { label: "Sex", placeholder: "1=M, 0=F" },
        { label: "CP", placeholder: "0-3" },
        { label: "Trestbps", placeholder: "e.g., 120" },
        { label: "Chol", placeholder: "e.g., 210" },
        { label: "FBS", placeholder: "1=T, 0=F" },
        { label: "RestECG", placeholder: "0-2" },
        { label: "Thalach", placeholder: "e.g., 150" },
        { label: "Exang", placeholder: "1=Y, 0=N" },
        { label: "Oldpeak", placeholder: "e.g., 1.5" },
        { label: "Slope", placeholder: "0-2" },
        { label: "CA", placeholder: "0-3" },
        { label: "Thal", placeholder: "1-3" },
      ];

      function createFormAndMetrics() {
        const formGrid = document.querySelector("#healthForm .grid");
        metrics.forEach((metric, i) => {
          const inputDiv = document.createElement("div");
          inputDiv.innerHTML = `
        <label for="feature${i}" class="block text-sm font-medium text-gray-400">${metric.label}</label>
        <input type="number" step="0.1" id="feature${i}" name="feature${i}" placeholder="${metric.placeholder}" class="w-full mt-1 p-2 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
      `;
          formGrid.appendChild(inputDiv);
        });
      }

      function setupTabs() {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        tabButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const tab = button.dataset.tab;
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            tabContents.forEach((content) => {
              content.classList.remove("active");
              if (content.id === tab) content.classList.add("active");
            });
          });
        });
      }

      async function handlePrediction(features) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML =
          '<div class="loader"></div><p class="mt-2">Analyzing...</p>';
        const token = localStorage.getItem("jarvis-token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          const res = await fetch(`${API_BASE_URL}/api/predict_health`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-access-token": token,
            },
            body: JSON.stringify({ features }),
          });
          const data = await res.json();

          if (res.ok) {
            const isPositive = data.prediction === "positive";
            const riskText = isPositive ? "High Risk" : "Low Risk";
            const riskValue = data.probability;
            const color = isPositive ? "#f87171" : "#4ade80";

            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - riskValue * circumference;

            resultDiv.innerHTML = `
          <div class="gauge-container">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle class="gauge-circle" cx="50" cy="50" r="${radius}" stroke="#374151"></circle>
              <circle class="gauge-circle gauge-meter" cx="50" cy="50" r="${radius}" stroke="${color}"
                stroke-dasharray="${circumference}"
                stroke-dashoffset="${circumference}"></circle>
              <text x="50" y="55" text-anchor="middle" class="gauge-text">${riskText}</text>
            </svg>
          </div>
          <p class="text-sm text-gray-400">Probability: ${(
            riskValue * 100
          ).toFixed(1)}%</p>
          <p class="text-sm text-gray-400">${
            isPositive
              ? "Please consult a doctor."
              : "Keep maintaining a healthy lifestyle."
          }</p>
        `;
            setTimeout(() => {
              const meter = resultDiv.querySelector(".gauge-meter");
              if (meter) meter.style.strokeDashoffset = offset;
            }, 100);
          } else {
            resultDiv.textContent = `Error: ${data.message}`;
          }
        } catch (err) {
          resultDiv.textContent = "Cannot connect to server.";
        }
      }

      document.getElementById("healthForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const features = Array.from({ length: 13 }, (_, i) =>
          parseFloat(document.getElementById(`feature${i}`).value)
        );
        if (features.some(isNaN)) {
          alert("Please fill all fields.");
          return;
        }
        handlePrediction(features);
      });

      // üîπ PDF Upload Handler
      document
        .getElementById("pdfSubmit")
        .addEventListener("click", async () => {
          const file = document.getElementById("pdfFile").files[0];
          if (!file) {
            alert("Please select a PDF file.");
            return;
          }

          const resultDiv = document.getElementById("result");
          resultDiv.innerHTML =
            '<div class="loader"></div><p class="mt-2">Analyzing PDF...</p>';

          const token = localStorage.getItem("jarvis-token");
          if (!token) {
            window.location.href = "login.html";
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          try {
            const res = await fetch(`${API_BASE_URL}/api/predict_health_pdf`, {
              method: "POST",
              headers: { "x-access-token": token },
              body: formData,
            });
            const data = await res.json();

            if (res.ok) {
              handlePrediction(data.features);
            } else {
              // If partial parsed values returned ‚Üí pre-fill form
              if (data.parsed) {
                Object.keys(data.parsed).forEach((key, idx) => {
                  const val = data.parsed[key];
                  if (val !== null) {
                    document.getElementById(`feature${idx}`).value = val;
                  }
                });
                alert(
                  "Some values missing in PDF. Please review pre-filled form."
                );
                document.querySelector("[data-tab='manual']").click();
              } else {
                resultDiv.textContent = `Error: ${data.message}`;
              }
            }
          } catch (err) {
            resultDiv.textContent = "Cannot connect to server.";
          }
        });

      document.addEventListener("DOMContentLoaded", () => {
        createFormAndMetrics();
        setupTabs();
      });
    </script>
  </body>
</html>
